<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Xem phim từ API (PRO)</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
body{background:#111;color:#fff;font-family:arial}
#episodes button{margin:4px;padding:8px 12px;cursor:pointer}
video{margin-top:10px}
input{width:600px;padding:6px}
</style>
</head>
<body>

<h2>Trình xem phim từ API</h2>

<input id="apiUrl" placeholder="Dán link API phim vào đây">
<button onclick="loadMovie()">Tải phim</button>

<div id="title"></div>
<div id="episodes"></div>

<video id="video" width="900" controls></video>

<script>
var video = document.getElementById('video');
var currentEpisodeKey = "";

function playVideo(url, episodeName){
    currentEpisodeKey = "movie_" + episodeName;

    if(Hls.isSupported()){
        var hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
    }else{
        video.src = url;
    }

    // Khi video load xong → kiểm tra có lưu thời gian cũ không
    video.onloadedmetadata = function(){
        var savedTime = localStorage.getItem(currentEpisodeKey);
        if(savedTime){
            video.currentTime = savedTime;
        }
    };

    // Cứ mỗi 5 giây → lưu thời gian hiện tại
    video.ontimeupdate = function(){
        localStorage.setItem(currentEpisodeKey, video.currentTime);
    };
}

function loadMovie(){
    var url = document.getElementById("apiUrl").value;

    fetch(url)
    .then(res=>res.json())
    .then(data=>{
        var movie = data.data.item;
        document.getElementById("title").innerHTML = "<h3>"+movie.name+"</h3>";

        var epDiv = document.getElementById("episodes");
        epDiv.innerHTML="";

        var episodes = movie.episodes[0].server_data;

        episodes.forEach(ep=>{
            var btn = document.createElement("button");

            var storageKey = "movie_" + ep.name;
            var savedTime = localStorage.getItem(storageKey);

            if(savedTime){
                var minutes = Math.floor(savedTime / 60);
                btn.innerText = "Tập " + ep.name + 
                    " ▶️ Xem tiếp từ phút " + minutes;
            }else{
                btn.innerText = "Tập " + ep.name;
            }

            btn.onclick = ()=> playVideo(ep.link_m3u8, ep.name);

            epDiv.appendChild(btn);
        });
    })
}

</script>


</body>
</html>
